<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickShare - Universal Uploader</title>
    <style>
        :root {
            --primary: #6366f1; /* Indigo */
            --primary-hover: #4f46e5;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --success: #10b981;
            --error: #ef4444;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
            --font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
        }

        /* --- Layout --- */
        .app-container {
            width: 100%;
            max-width: 600px;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            position: relative;
        }

        header h1 { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        header p { color: var(--text-muted); font-size: 0.9rem; margin-top: 0.25rem; }

        .history-btn {
            position: absolute;
            top: 1.5rem;
            right: 2rem;
            background: #1e293b;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.85rem;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
            height: 36px;
        }
        .history-btn:hover { background-color: #0f172a; }

        /* --- Upload Area --- */
        .upload-section { padding: 2rem; }

        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 3rem 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background-color: #f9fafb;
            position: relative;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--primary);
            background-color: rgba(99, 102, 241, 0.05);
        }

        .drop-zone-icon { font-size: 3rem; margin-bottom: 1rem; display: block; color: var(--text-muted); }
        .drop-zone h3 { font-size: 1.1rem; margin-bottom: 0.5rem; color: var(--text-main); }
        .drop-zone p { font-size: 0.875rem; color: var(--text-muted); }

        .paste-btn {
            margin-top: 1rem;
            background: #fff;
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--text-main);
            font-weight: 500;
        }
        .paste-btn:hover { border-color: var(--primary); color: var(--primary); }

        /* --- URL Input --- */
        .url-container {
            margin-top: 1.5rem;
            display: flex;
            gap: 0.5rem;
        }

        .url-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .url-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }

        .url-btn {
            background-color: #1e293b;
            color: white;
            border: none;
            padding: 0 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            height: 46px; /* Match input height roughly */
            align-self: center;
        }
        .url-btn:hover { background-color: #0f172a; }

        /* --- File List --- */
        .file-list {
            background-color: #f8fafc;
            border-top: 1px solid var(--border-color);
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            background: white;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: background 0.2s;
            animation: slideIn 0.3s ease-out;
        }
        .file-item:last-child { border-bottom: none; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Item Components */
        .icon-box {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background-color: #f1f5f9;
            color: var(--text-muted);
        }

        .icon-box.uploading { color: var(--primary); background-color: rgba(99, 102, 241, 0.1); }
        .icon-box.success { color: var(--success); background-color: rgba(16, 185, 129, 0.1); }
        .icon-box.error { color: var(--error); background-color: rgba(239, 68, 68, 0.1); }

        .file-info { flex: 1; min-width: 0; }

        .file-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        .status-text { font-size: 0.8rem; color: var(--text-muted); }
        .status-text.error { color: var(--error); }
        .status-text.success { color: var(--success); }

        .url-box {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
            background: #f1f5f9;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
            gap: 0.5rem;
        }

        .url-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-main);
            font-family: monospace;
        }

        .action-group { display: flex; gap: 0.25rem; }

        .mini-btn {
            padding: 0.25rem 0.6rem;
            font-size: 0.75rem;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 50px;
            cursor: pointer;
            color: var(--text-muted);
            font-weight: 600;
            transition: all 0.2s;
        }
        .mini-btn:hover { border-color: var(--text-muted); color: var(--text-main); }

        /* Folder Item Special Style */
        .file-item.folder-item {
            background-color: rgba(16, 185, 129, 0.03);
            border-left: 4px solid var(--success);
        }

        /* --- Spinner --- */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Toast --- */
        .snackbar {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1e293b;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000;
        }
        .snackbar.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { font-size: 1.25rem; font-weight: 700; }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%;
        }
        .modal-close:hover { background: #f1f5f9; color: var(--error); }

        .modal-body {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 1rem 2rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
        }

        .clear-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .clear-btn:hover { opacity: 0.9; }

        .history-item {
            background: white;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .history-info { flex: 1; min-width: 0; }
        .history-link {
            display: block;
            color: var(--primary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }
        .history-link:hover { text-decoration: underline; }
        .history-date { font-size: 0.75rem; color: var(--text-muted); }

        .empty-history {
            text-align: center;
            color: var(--text-muted);
            padding: 3rem 1rem;
        }

        /* --- Footer --- */
        .footer { margin-top: 2rem; text-align: center; }
        .made-by-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            transition: color 0.2s;
        }
        .made-by-btn:hover { color: var(--primary); }

        @media (max-width: 480px) {
            .upload-section { padding: 1.5rem 1rem; }
            .drop-zone { padding: 2rem 1rem; }
            .url-container { flex-direction: column; }
            .url-btn { width: 100%; height: 40px; }
            .history-btn { position: static; margin-top: 1rem; width: 100%; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <h1>File Uploader</h1>
            <p>Upload images, documents, archives, or paste URLs</p>
            <button id="historyBtn" class="history-btn">üìú History</button>
        </header>

        <div class="upload-section">
            <div class="drop-zone" id="dropZone">
                <span class="drop-zone-icon">‚òÅÔ∏è</span>
                <h3>Drag & Drop or Click to Browse</h3>
                <p>Supports all file types (Max 24MB)</p>
                <button id="pasteBtn" class="paste-btn">üìã Paste from Clipboard</button>
                <input type="file" id="fileInput" multiple accept="*/*" style="display: none;">
            </div>

            <div class="url-container">
                <input type="text" id="urlInput" class="url-input" placeholder="Paste direct file URL here..." />
                <button id="urlUpload" class="url-btn">Fetch & Upload</button>
            </div>
        </div>

        <div class="file-list" id="fileList"></div>
    </div>

    <div class="snackbar" id="snackbar"></div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Upload History</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="historyList">
                <!-- Items injected via JS -->
            </div>
            <div class="modal-footer">
                <button class="clear-btn" id="clearHistory">Clear History</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <button class="made-by-btn" onclick="window.open('https://github.com/rachit9876', '_blank')">Made by Rachit</button>
    </footer>

    <script>
        // --- DOM Elements ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const urlInput = document.getElementById('urlInput');
        const urlUpload = document.getElementById('urlUpload');
        const pasteBtn = document.getElementById('pasteBtn');
        const snackbar = document.getElementById('snackbar');
        
        // Modal Elements
        const historyBtn = document.getElementById('historyBtn');
        const historyModal = document.getElementById('historyModal');
        const closeModal = document.getElementById('closeModal');
        const clearHistory = document.getElementById('clearHistory');
        const historyList = document.getElementById('historyList');

        // --- State ---
        let uploadedFiles = [];
        let folderItem = null;
        const HISTORY_KEY = 'upload_history_v2';

        // --- Event Listeners ---
        
        // Drag & Drop
        document.body.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        document.body.addEventListener('dragleave', (e) => {
            if (e.target === document.body) dropZone.classList.remove('dragover');
        });
        document.body.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            const url = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain');
            if (files.length) handleFiles(files);
            else if (url && url.match(/^https?:\/\//i)) handleUrl(url);
        });

        // Drop Zone Interactions
        dropZone.addEventListener('dragover', (e) => e.preventDefault());
        dropZone.addEventListener('drop', (e) => e.preventDefault());
        dropZone.addEventListener('click', (e) => {
            if (e.target !== pasteBtn) fileInput.click();
        });

        // File Selection
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFiles(e.target.files);
        });

        // URL Handling
        urlUpload.addEventListener('click', () => {
            const url = urlInput.value.trim();
            if (url) handleUrl(url);
        });
        urlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const url = urlInput.value.trim();
                if (url) handleUrl(url);
            }
        });

        // Paste Handling
        pasteBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const ok = await pasteFromClipboard();
            if (!ok) showSnackbar('Clipboard empty or invalid format.');
        });

        document.addEventListener('paste', async (e) => {
            try {
                const items = e.clipboardData?.items || [];
                let handled = false;

                // Handle Blob/Image
                for (const it of items) {
                    if (!it.type || !it.type.startsWith('image/')) continue;
                    const blob = it.getAsFile();
                    if (!blob) continue;
                    const ext = (it.type.split('/')[1] || 'png').toLowerCase();
                    const file = new File([blob], `pasted-${Date.now()}.${ext}`, { type: it.type });
                    await handleFiles([file]);
                    handled = true;
                    break;
                }

                if (handled) return;

                // Handle Text URL
                const text = e.clipboardData?.getData('text/uri-list') || e.clipboardData?.getData('text/plain');
                if (text && /^https?:\/\//i.test(text.trim())) {
                    await handleUrl(text.trim());
                }
            } catch (err) { console.error('Paste error:', err); }
        });

        // Modal Events
        historyBtn.addEventListener('click', () => {
            loadHistory();
            historyModal.classList.add('show');
        });

        closeModal.addEventListener('click', () => historyModal.classList.remove('show'));
        
        historyModal.addEventListener('click', (e) => {
            if (e.target === historyModal) historyModal.classList.remove('show');
        });

        clearHistory.addEventListener('click', () => {
            if (confirm('Clear all upload history?')) {
                localStorage.removeItem(HISTORY_KEY);
                loadHistory();
                showSnackbar('History cleared');
            }
        });

        // --- Logic Functions ---

        async function pasteFromClipboard() {
            if (navigator.clipboard?.read) {
                try {
                    const items = await navigator.clipboard.read();
                    for (const item of items) {
                        const imageType = item.types.find(t => t.startsWith('image/'));
                        if (!imageType) continue;
                        const blob = await item.getType(imageType);
                        const ext = (imageType.split('/')[1] || 'png').toLowerCase();
                        const file = new File([blob], `pasted-${Date.now()}.${ext}`, { type: imageType });
                        await handleFiles([file]);
                        return true;
                    }
                } catch { /* fallback */ }
            }
            if (navigator.clipboard?.readText) {
                try {
                    const text = (await navigator.clipboard.readText()).trim();
                    if (text && /^https?:\/\//i.test(text)) {
                        await handleUrl(text);
                        return true;
                    }
                } catch { /* fallback */ }
            }
            return false;
        }

        // --- UI Renderers ---

        function createItemShell() {
            const div = document.createElement('div');
            div.className = 'file-item';
            const icon = document.createElement('div');
            icon.className = 'icon-box';
            const info = document.createElement('div');
            info.className = 'file-info';
            div.appendChild(icon);
            div.appendChild(info);
            fileList.prepend(div);
            return { div, icon, info };
        }

        function renderLoading(itemObj, name) {
            itemObj.div.className = 'file-item';
            itemObj.icon.className = 'icon-box uploading';
            itemObj.icon.innerHTML = '<div class="spinner"></div>';
            itemObj.info.innerHTML = `
                <span class="file-name">${name}</span>
                <span class="status-text">Uploading...</span>
            `;
        }

        function renderError(itemObj, name, msg) {
            itemObj.div.className = 'file-item';
            itemObj.icon.className = 'icon-box error';
            itemObj.icon.innerHTML = '‚ö†Ô∏è';
            itemObj.info.innerHTML = `
                <span class="file-name">${name}</span>
                <span class="status-text error">${msg}</span>
            `;
        }

        function renderSuccess(itemObj, name, url) {
            itemObj.div.className = 'file-item';
            itemObj.icon.className = 'icon-box success';
            itemObj.icon.innerHTML = '‚úì';
            const info = itemObj.info;
            info.innerHTML = `
                <span class="file-name">${name}</span>
                <div class="url-box">
                    <span class="url-text">${url}</span>
                    <div class="action-group">
                        <button class="mini-btn open-action">Open</button>
                        <button class="mini-btn copy-action">Copy</button>
                    </div>
                </div>
            `;
            info.querySelector('.open-action').addEventListener('click', () => window.open(url, '_blank'));
            info.querySelector('.copy-action').addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(url);
                    const btn = info.querySelector('.copy-action');
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = originalText, 1500);
                    showSnackbar('Link copied');
                } catch { showSnackbar('Copy failed'); }
            });
        }

        // --- Upload Handlers ---

        async function handleFiles(files) {
            for (const file of files) {
                const { div, icon, info } = createItemShell();
                renderLoading({ div, icon, info }, file.name);

                if (file.size > 24 * 1024 * 1024) {
                    renderError({ div, icon, info }, file.name, 'File too large (Max 24MB)');
                    continue;
                }

                await uploadFile(file, { div, icon, info });
                fileInput.value = '';
            }
        }

        async function handleUrl(url) {
            const { div, icon, info } = createItemShell();
            const filename = url.split('/').pop().split('?')[0] || 'downloaded-file';
            renderLoading({ div, icon, info }, filename);

            try {
                const res = await fetch('/api/fetch-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error);
                
                const ext = data.type.split('/')[1] || 'bin';
                const finalFilename = filename.includes('.') ? filename : `${filename}.${ext}`;
                
                const uploadRes = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: finalFilename, content: data.base64 })
                });
                const uploadData = await uploadRes.json();
                
                if (uploadData.success) {
                    const uploadedFilename = uploadData.url.split('/').pop();
                    renderSuccess({ div, icon, info }, finalFilename, uploadData.url);
                    showSnackbar(uploadData.cached ? 'File already exists' : 'Uploaded successfully');
                    uploadedFiles.push(uploadedFilename);
                    saveToHistory(uploadData.url, finalFilename);
                    updateFolderUrl();
                } else {
                    throw new Error(uploadData.error);
                }
                urlInput.value = '';
            } catch (err) {
                renderError({ div, icon, info }, filename, err?.message || 'Upload failed');
            }
        }

        async function uploadFile(file, itemObj) {
            try {
                const base64 = await fileToBase64(file);
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: file.name, content: base64 })
                });
                const data = await res.json();
                
                if (data.success) {
                    const filename = data.url.split('/').pop();
                    renderSuccess(itemObj, file.name, data.url);
                    showSnackbar(data.cached ? 'File already exists' : 'Uploaded successfully');
                    uploadedFiles.push(filename);
                    saveToHistory(data.url, file.name);
                    updateFolderUrl();
                } else {
                    renderError(itemObj, file.name, data.error || 'Upload failed');
                }
            } catch (err) {
                renderError(itemObj, file.name, 'Network error');
            }
        }

        // --- Utilities ---

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function showSnackbar(msg) {
            snackbar.textContent = msg;
            snackbar.classList.add('show');
            setTimeout(() => snackbar.classList.remove('show'), 3000);
        }

        // --- History Management ---

        function saveToHistory(url, filename) {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            // Prevent duplicates at the top
            if (history.length > 0 && history[0].url === url) return;
            
            history.unshift({ url, filename, timestamp: Date.now() });
            if (history.length > 50) history.pop(); // Limit to 50 items
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }

        function createHistoryItem(item) {
            const div = document.createElement('div');
            div.className = 'history-item';
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'history-info';
            
            const link = document.createElement('a');
            link.href = item.url;
            link.target = '_blank';
            link.className = 'history-link';
            link.textContent = item.filename;
            
            const date = document.createElement('div');
            date.className = 'history-date';
            date.textContent = new Date(item.timestamp).toLocaleString();

            infoDiv.appendChild(link);
            infoDiv.appendChild(date);

            const actionGroup = document.createElement('div');
            actionGroup.className = 'action-group';

            const copyBtn = document.createElement('button');
            copyBtn.className = 'mini-btn';
            copyBtn.textContent = 'Copy';
            copyBtn.onclick = async () => {
                try {
                    await navigator.clipboard.writeText(item.url);
                    showSnackbar('Link copied');
                } catch { showSnackbar('Failed to copy'); }
            };

            actionGroup.appendChild(copyBtn);
            div.appendChild(infoDiv);
            div.appendChild(actionGroup);
            
            return div;
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                historyList.innerHTML = '<div class="empty-history">No upload history yet</div>';
                return;
            }

            history.forEach(item => {
                historyList.appendChild(createHistoryItem(item));
            });
        }

        // --- Folder Logic (Refactored for Safety) ---
        
        const EXT_TO_IDX = { jpg: 0, jpeg: 0, png: 1, gif: 2, webp: 3 };
        const IDX_TO_EXT = ['jpg', 'png', 'gif', 'webp'];

        function encodeFilesToHash(files) {
            const bytes = new Uint8Array(files.length * 7);
            let offset = 0;
            for (const f of files) {
                const dotIdx = f.lastIndexOf('.');
                // Handle cases where extension might be missing or unknown
                const hex = dotIdx > -1 ? f.slice(0, dotIdx) : f; 
                const ext = dotIdx > -1 ? f.slice(dotIdx + 1).toLowerCase() : 'jpg';
                
                // Safety: Ensure hex is valid for parsing
                const cleanHex = hex.replace(/[^0-9a-fA-F]/g, '').padEnd(12, '0').slice(0, 12);
                
                for (let i = 0; i < 12; i += 2) {
                    bytes[offset++] = parseInt(cleanHex.slice(i, i + 2), 16);
                }
                bytes[offset++] = EXT_TO_IDX[ext] ?? 0; // Default to 0 (jpg) if unknown
            }
            
            let binary = '';
            for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
            return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        function updateFolderUrl() {
            if (uploadedFiles.length < 2) return;
            const encoded = encodeFilesToHash(uploadedFiles);
            const folderUrl = `${location.origin}/folder.html#${encoded}`;
            
            if (!folderItem) {
                folderItem = document.createElement('div');
                folderItem.className = 'file-item folder-item';
                const icon = document.createElement('div');
                icon.className = 'icon-box success';
                icon.innerHTML = 'üìÅ';
                const info = document.createElement('div');
                info.className = 'file-info';
                folderItem.appendChild(icon);
                folderItem.appendChild(info);
                fileList.insertBefore(folderItem, fileList.firstChild);
            }
            
            const info = folderItem.querySelector('.file-info');
            const name = `Folder View (${uploadedFiles.length} files)`;
            
            info.innerHTML = `
                <span class="file-name">${name}</span>
                <div class="url-box">
                    <span class="url-text">${folderUrl}</span>
                    <div class="action-group">
                        <button class="mini-btn open-action">Open</button>
                        <button class="mini-btn copy-action">Copy</button>
                    </div>
                </div>
            `;
            
            info.querySelector('.open-action').addEventListener('click', () => window.open(folderUrl, '_blank'));
            info.querySelector('.copy-action').addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(folderUrl);
                    const btn = info.querySelector('.copy-action');
                    const originalText = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = originalText, 1500);
                    showSnackbar('Folder link copied');
                } catch { showSnackbar('Failed to copy'); }
            });
        }
    </script>
</body>
</html>