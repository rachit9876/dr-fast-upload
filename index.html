<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickShare - Universal Uploader</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="/assets/logo.webp" type="image/webp">
</head>
<body>

    <div class="container-sm card">
        <header class="header" style="padding: 1.5rem; border-bottom: 1px solid var(--border); margin:0;">
            <div class="flex-between" style="margin-bottom: 0.5rem;">
                <h1>File Uploader</h1>
                <button id="historyBtn" class="btn btn-primary btn-sm">üìú History</button>
            </div>
            <p>Upload images, documents, archives, or paste URLs</p>
        </header>

        <div style="padding: 2rem;">
            <div class="drop-zone" id="dropZone">
                <span class="drop-icon">‚òÅÔ∏è</span>
                <h3 style="margin-bottom:0.5rem;">Drag & Drop or Click to Browse</h3>
                <p class="item-subtitle">Supports all file types (Max 24MB)</p>
                <div style="margin-top: 1rem;">
                    <button id="pasteBtn" class="btn btn-outline btn-sm">üìã Paste Clipboard</button>
                </div>
                <input type="file" id="fileInput" multiple accept="*/*" style="display: none;">
            </div>

            <div class="input-group" style="margin-top: 1.5rem;">
                <input type="text" id="urlInput" class="input" placeholder="Paste direct file URL here..." />
                <button id="urlUpload" class="btn btn-primary">Fetch</button>
            </div>
        </div>

        <div class="list-container" id="fileList">
            <!-- Files appear here -->
        </div>
    </div>

    <div class="snackbar" id="snackbar"></div>

    <!-- History Modal -->
    <div class="overlay" id="historyModal">
        <div class="modal-box">
            <div class="modal-header">
                <h3>Upload History</h3>
                <button class="btn btn-outline btn-icon" id="closeModal" style="width:32px; height:32px;">&times;</button>
            </div>
            <div class="modal-body" id="historyList">
                <!-- History Items -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-sm" id="clearHistory">Clear History</button>
            </div>
        </div>
    </div>

    <footer style="margin-top: 2rem; text-align: center;">
        <button class="btn btn-outline btn-sm" onclick="window.open('https://github.com/rachit9876', '_blank')">Made by Rachit</button>
    </footer>

    <script>
        // --- Elements ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const urlInput = document.getElementById('urlInput');
        const urlUpload = document.getElementById('urlUpload');
        const pasteBtn = document.getElementById('pasteBtn');
        const snackbar = document.getElementById('snackbar');
        const historyBtn = document.getElementById('historyBtn');
        const historyModal = document.getElementById('historyModal');
        const closeModal = document.getElementById('closeModal');
        const clearHistory = document.getElementById('clearHistory');
        const historyList = document.getElementById('historyList');

        // --- State ---
        let uploadedFiles = []; // Stores file IDs/Names for folder generation
        let folderItem = null;  // DOM element for the folder link
        const HISTORY_KEY = 'upload_history_v2';
        const EXT_TO_IDX = { jpg: 0, jpeg: 0, png: 1, gif: 2, webp: 3, pdf: 4, txt: 4 };

        // --- Drag & Drop Events ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        document.body.addEventListener('dragover', () => dropZone.classList.add('dragover'));
        document.body.addEventListener('dragleave', (e) => {
            if (e.target === document.body) dropZone.classList.remove('dragover');
        });
        document.body.addEventListener('drop', (e) => {
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            const url = e.dataTransfer.getData('text/uri-list') || e.dataTransfer.getData('text/plain');
            
            if (files.length) {
                handleFiles(files);
            } else if (url && /^https?:\/\//i.test(url)) {
                handleUrl(url);
            }
        });

        // --- Click & Input Events ---
        dropZone.addEventListener('click', (e) => {
            if (e.target !== pasteBtn && !pasteBtn.contains(e.target)) {
                fileInput.click();
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFiles(e.target.files);
                fileInput.value = ''; // Reset to allow re-uploading same file
            }
        });

        urlUpload.addEventListener('click', () => {
            const val = urlInput.value.trim();
            if (val) handleUrl(val);
        });

        pasteBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const success = await pasteFromClipboard();
            if (!success) showSnackbar('Clipboard empty or contains no image.');
        });

        // Modal Events
        historyBtn.addEventListener('click', () => {
            loadHistory();
            historyModal.classList.add('show');
        });
        closeModal.addEventListener('click', () => historyModal.classList.remove('show'));
        clearHistory.addEventListener('click', () => {
            if(confirm('Clear all history?')) {
                localStorage.removeItem(HISTORY_KEY);
                loadHistory();
                showSnackbar('History cleared');
            }
        });

        // --- Logic Handlers ---

        async function pasteFromClipboard() {
            try {
                const items = await navigator.clipboard.read();
                for (const item of items) {
                    const type = item.types.find(t => t.startsWith('image/'));
                    if (type) {
                        const blob = await item.getType(type);
                        const ext = type.split('/')[1] || 'png';
                        const file = new File([blob], `pasted-${Date.now()}.${ext}`, { type });
                        await handleFiles([file]);
                        return true;
                    }
                }
                // Fallback for text URL
                const text = await navigator.clipboard.readText();
                if (text && /^https?:\/\//i.test(text.trim())) {
                    await handleUrl(text.trim());
                    return true;
                }
            } catch (err) {
                console.error("Clipboard error:", err);
            }
            return false;
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                const shell = createItemShell();
                renderLoading(shell, file.name);
                
                if (file.size > 24 * 1024 * 1024) {
                    renderError(shell, file.name, 'File too large (>24MB)');
                    return;
                }
                
                uploadLogic(file, shell);
            });
        }

        async function handleUrl(url) {
            const fileName = url.split('/').pop().split('?')[0] || 'remote-file';
            const shell = createItemShell();
            renderLoading(shell, fileName);

            try {
                // Simulate fetching the URL or processing it
                // In a real app, you'd send the URL to backend to download
                // Here we simulate a successful upload of a remote resource
                await new Promise(r => setTimeout(r, 1000)); 
                
                const mockId = Math.random().toString(36).substring(2, 8) + "url";
                const mockUrl = url; // Assuming the URL itself is the result, or a proxy
                
                renderSuccess(shell, fileName, mockUrl);
                uploadedFiles.push(mockId);
                saveToHistory(mockUrl, fileName);
                updateFolderUrl();
                showSnackbar('URL processed successfully');
            } catch (err) {
                renderError(shell, fileName, 'Failed to process URL');
            }
        }

        async function uploadLogic(file, shell) {
            try {
                const reader = new FileReader();
                reader.onload = async () => {
                    const base64 = reader.result.split(',')[1];
                    
                    // --- SIMULATION START ---
                    // In a real environment, you would fetch('/api/upload', ...).
                    // Since we don't have a backend, we simulate the network request.
                    // If you have a real backend, uncomment the fetch block below.
                    
                    /*
                    const res = await fetch('/api/upload', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: file.name, content: base64 })
                    });
                    const data = await res.json();
                    */

                    // Simulating a successful response for demo purposes:
                    await new Promise(resolve => setTimeout(resolve, 1500)); // Fake delay
                    const mockExt = file.name.split('.').pop();
                    const mockId = Math.random().toString(36).substring(2, 8); 
                    const mockUrl = `${location.origin}/public/${mockId}.${mockExt}`;
                    const data = { success: true, url: mockUrl };
                    // --- SIMULATION END ---

                    if (data.success) {
                        renderSuccess(shell, file.name, data.url);
                        // Extract ID for folder generation (mock logic)
                        const fileId = mockId + '.' + mockExt;
                        uploadedFiles.push(fileId);
                        saveToHistory(data.url, file.name);
                        updateFolderUrl();
                    } else {
                        renderError(shell, file.name, data.error || 'Upload failed');
                    }
                };
                reader.readAsDataURL(file);
            } catch (e) {
                renderError(shell, file.name, 'Read error');
            }
        }

        // --- Rendering Helpers ---

        function createItemShell() {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div class="item-icon"></div>
                <div class="item-content"></div>
            `;
            fileList.prepend(div);
            return {
                div,
                icon: div.querySelector('.item-icon'),
                info: div.querySelector('.item-content')
            };
        }

        function renderLoading(obj, name) {
            obj.icon.className = 'item-icon uploading';
            obj.icon.innerHTML = '<div class="spinner"></div>';
            obj.info.innerHTML = `
                <span class="item-title">${name}</span>
                <span class="item-subtitle">Uploading...</span>
            `;
        }

        function renderError(obj, name, msg) {
            obj.icon.className = 'item-icon error';
            obj.icon.innerHTML = '‚ö†Ô∏è';
            obj.info.innerHTML = `
                <span class="item-title">${name}</span>
                <span class="item-subtitle" style="color:var(--error)">${msg}</span>
            `;
        }

        function renderSuccess(obj, name, url) {
            obj.icon.className = 'item-icon success';
            obj.icon.innerHTML = '‚úì';
            obj.info.innerHTML = `
                <span class="item-title">${name}</span>
                <div class="url-box">
                    <span class="url-text">${url}</span>
                    <button class="btn btn-outline btn-sm copy-btn" style="padding: 2px 8px; font-size: 0.75rem;">Copy</button>
                    <button class="btn btn-outline btn-sm open-btn" style="padding: 2px 8px; font-size: 0.75rem;">Open</button>
                </div>
            `;
            
            obj.info.querySelector('.copy-btn').onclick = () => {
                navigator.clipboard.writeText(url);
                showSnackbar('Copied to clipboard!');
            };
            obj.info.querySelector('.open-btn').onclick = () => window.open(url, '_blank');
        }

        // --- Folder Logic ---
        function updateFolderUrl() {
            if (uploadedFiles.length === 0) return;

            // This replicates the binary encoding logic from the original script
            // It compresses the list of files into a URL hash
            try {
                const parts = uploadedFiles.map(f => {
                    const name = f.split('.')[0];
                    const ext = f.split('.').pop().toLowerCase();
                    const idx = EXT_TO_IDX[ext] || 0;
                    
                    // Pack hex (6 chars) + type (1 char)
                    if (name.length !== 6) return null; // Skip if not standard ID format
                    const hex = name; 
                    const binStr = hex.match(/.{1,2}/g).map(byte => String.fromCharCode(parseInt(byte, 16))).join('');
                    return binStr + String.fromCharCode(idx);
                }).filter(Boolean);

                if (parts.length === 0) return;
                
                const combined = parts.join('');
                const b64 = btoa(combined).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
                
                const folderLink = `folder.html#${b64}`;

                if (!folderItem) {
                    folderItem = document.createElement('div');
                    folderItem.className = 'list-item';
                    folderItem.style.background = 'rgba(16, 185, 129, 0.05)';
                    folderItem.style.borderBottom = 'none'; // Visual separator
                    folderItem.innerHTML = `
                        <div class="item-icon success">üìÅ</div>
                        <div class="item-content"></div>
                    `;
                    fileList.insertBefore(folderItem, fileList.firstChild);
                }

                const contentDiv = folderItem.querySelector('.item-content');
                contentDiv.innerHTML = `
                    <span class="item-title">Folder Link (${uploadedFiles.length} files)</span>
                    <div class="url-box">
                        <span class="url-text" style="color:var(--success); font-weight:600;">Share this folder</span>
                        <button class="btn btn-outline btn-sm copy-folder" style="padding: 2px 8px; font-size: 0.75rem;">Copy Link</button>
                    </div>
                `;

                contentDiv.querySelector('.copy-folder').onclick = () => {
                    // Create absolute link
                    const absUrl = new URL(folderLink, window.location.href).href;
                    navigator.clipboard.writeText(absUrl);
                    showSnackbar('Folder link copied!');
                };

            } catch (e) {
                console.error("Folder generation error", e);
            }
        }

        // --- History Logic ---
        function saveToHistory(url, filename) {
            const hist = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            // Prevent duplicates at top
            if (hist[0]?.url === url) return;
            
            hist.unshift({ url, filename, timestamp: Date.now() });
            if (hist.length > 50) hist.pop();
            localStorage.setItem(HISTORY_KEY, JSON.stringify(hist));
        }

        function loadHistory() {
            const hist = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            historyList.innerHTML = '';
            
            if (!hist.length) {
                historyList.innerHTML = '<p class="item-subtitle" style="text-align:center; padding:1rem;">No history yet.</p>';
                return;
            }

            hist.forEach(h => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="item-icon">üïí</div>
                    <div class="item-content">
                        <a href="${h.url}" target="_blank" class="item-title" style="color:var(--primary); text-decoration:none;">${h.filename}</a>
                        <span class="item-subtitle">${new Date(h.timestamp).toLocaleString()}</span>
                    </div>
                    <button class="btn btn-outline btn-sm copy-hist">Copy</button>
                `;
                div.querySelector('.copy-hist').onclick = () => {
                    navigator.clipboard.writeText(h.url);
                    showSnackbar('Link copied');
                };
                historyList.appendChild(div);
            });
        }

        // --- Utilities ---
        function showSnackbar(msg) {
            snackbar.textContent = msg;
            snackbar.classList.add('show');
            setTimeout(() => snackbar.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>